<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.web.app.user.UserMapper">
	<select id="selectUserList" resultType="map">
		select user_id   as userId
			  ,username  as username	
			  ,email     as email
			  ,date_format(str_to_date(birth,'%Y%m%d'), '%Y-%m-%d') as birth
			  ,phone     as phone
			  ,join_date as joinDate
			  ,upt_dt    as uptDt
		  from user_info
		 where 1=1
		 <if test="id != '' and id != null">
		   and user_id = #{id}
		 </if> 
	</select>
	
	<select id="selectUserInfo" resultType="com.web.app.user.UserForm">
		select a.user_id                       as userId
			  ,a.username                      as username	
			  ,SUBSTRING_INDEX(a.email,'@',1)  as emailId
              ,concat('@', SUBSTRING_INDEX(a.email,'@',-1)) as emailAddr
              ,concat('@', SUBSTRING_INDEX(a.email,'@',-1)) as txtEmailAddr
			  ,SUBSTR(a.birth,1,4)             as year
              ,SUBSTR(a.birth,5,2)             as month
              ,SUBSTR(a.birth,7,2)             as day
              ,SUBSTR(a.phone,1,3)             as serial
              ,SUBSTR(a.phone,4,4)             as phoneNum1
              ,SUBSTR(a.phone,8,4)             as phoneNum2
			  ,a.join_date                     as joinDate
			  ,a.user_role                     as userRole
			  ,a.upt_dt                        as uptDt
			  ,convert(ifnull(DATEDIFF(sysdate(), a.upt_dt), 0), char) as lastupdatediff
			  ,ifnull(b.storedFileNm,'-') as fileNm
		  from user_info a
		  left outer join tb_file_mng b on a.user_id = b.refKey
		  							   and b.refWord = 'USER'		
		 where 1=1
		 <if test="userId != '' and userId != null">
		   and user_id = #{userId}
		 </if>   	
	</select>	   
	
	
	<update id="updateUserList" parameterType="map">
		update user_info
		   set title = #{title}
			  ,content = #{content}
           	  ,writer = #{writer}
           	  ,user_role = #{userRole}
           	  ,upt_dt = sysdate()
		 where user_id = #{id}   
	</update>
	
	<delete id="deleteUserList" parameterType="map">
		delete 
		  from user_info
		 where user_id = #{id}   
	</delete>
	
	<insert id="saveLoginUserLog" parameterType="map">
		insert into user_connect_log_history(
			 ID
			,LOG_TYPE
			,IP
			,HOSTNAME
			,CONNECT_DT
		)values(
			 #{loginId} 
			,'LOGIN'
			,#{ip}
			,#{HostName}
			,sysdate()
		)
	</insert>
	
	
</mapper>